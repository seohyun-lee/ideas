import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  Play, Square, RefreshCcw, Music, Trees, Rocket, Snowflake, Monitor, Disc, 
  ChevronLeft, ChevronRight, Activity, ArrowLeft, Zap, Gamepad2, Grid, Headphones, Wind, FlaskConical
} from 'lucide-react';

// ==========================================
// ğŸµ GAME DATA & CONSTANTS
// ==========================================

// ë…¸íŠ¸ ìƒ‰ìƒ: íŒŒìŠ¤í…”í†¤(400ë²ˆëŒ€)ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ëŠë‚Œ ê°•ì¡°
const NOTES = [
  { name: 'C5', freq: 523.25, color: 'bg-rose-400', glow: '#fb7185' },
  { name: 'B4', freq: 493.88, color: 'bg-orange-400', glow: '#fb923c' },
  { name: 'A4', freq: 440.00, color: 'bg-amber-400', glow: '#fbbf24' },
  { name: 'G4', freq: 392.00, color: 'bg-yellow-400', glow: '#facc15' },
  { name: 'F4', freq: 349.23, color: 'bg-emerald-400', glow: '#34d399' },
  { name: 'E4', freq: 329.63, color: 'bg-cyan-400', glow: '#22d3ee' },
  { name: 'D4', freq: 293.66, color: 'bg-blue-400', glow: '#60a5fa' },
  { name: 'C4', freq: 261.63, color: 'bg-indigo-400', glow: '#818cf8' },
];

const STEPS_PER_BAR = 16;
const INITIAL_BPM = 120;

const THEMES = {
  nature: { 
    id: 'nature', 
    name: 'Forest', 
    icon: <Trees size={16} />, 
    desc: 'ê¹Šì€ ìˆ²ì†ì˜ ì†ì‚­ì„', 
    bg: 'bg-gradient-to-br from-[#2c3333] to-[#1a1f1f]', 
    panelBg: 'bg-[#2e4f4f]/90 border border-[#4e6f6f]/50 shadow-[0_20px_50px_rgba(0,0,0,0.5)] backdrop-blur-md', 
    text: 'text-emerald-50', 
    accent: 'bg-[#cbe4de] text-[#2c3333]', 
    waveform: 'triangle', 
    shape: 'rounded-full', 
    envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.2 }, 
    gridBase: 'bg-black/30', 
    playhead: 'bg-[#cbe4de]', 
    sliderTrack: 'bg-[#0e8388]/40' 
  },
  space: { 
    id: 'space', 
    name: 'Galaxy', 
    icon: <Rocket size={16} />, 
    desc: 'ë¨¼ ìš°ì£¼ì—ì„œ ì˜¨ ì‹ í˜¸', 
    bg: 'bg-[#0f172a]', 
    panelBg: 'bg-slate-900/80 border border-indigo-500/30 shadow-2xl backdrop-blur-xl', 
    text: 'text-slate-200', 
    accent: 'bg-indigo-500 text-white', 
    waveform: 'sine', 
    shape: 'rounded-sm', 
    envelope: { attack: 0.05, decay: 0.2, sustain: 0.6, release: 1.5 }, 
    gridBase: 'bg-white/10', 
    playhead: 'bg-indigo-400', 
    sliderTrack: 'bg-slate-800' 
  },
  winter: { 
    id: 'winter', 
    name: 'Snow', 
    icon: <Snowflake size={16} />, 
    desc: 'ëˆˆ ë‚´ë¦¬ëŠ” ë‚ ì˜ ì˜¤ë¥´ê³¨', 
    bg: 'bg-gradient-to-b from-[#e0f2fe] to-[#f0f9ff]',
    panelBg: 'bg-white/70 border border-white/60 shadow-xl backdrop-blur-xl', 
    text: 'text-slate-500', 
    accent: 'bg-sky-400 text-white', 
    waveform: 'sine', 
    shape: 'rounded-2xl', 
    envelope: { attack: 0.001, decay: 0.3, sustain: 0.1, release: 0.8 }, 
    gridBase: 'bg-white', 
    playhead: 'bg-sky-400', 
    sliderTrack: 'bg-slate-200' 
  },
  cyber: { 
    id: 'cyber', 
    name: 'Cyber', 
    icon: <Monitor size={16} />, 
    desc: 'ì˜¤ë˜ëœ ì•„ì¼€ì´ë“œ ê²Œì„ê¸°', 
    bg: 'bg-zinc-950', 
    panelBg: 'bg-zinc-900/90 border border-green-500/30 shadow-2xl backdrop-blur-md', 
    text: 'text-green-500', 
    accent: 'bg-green-500 text-black', 
    waveform: 'square', 
    shape: 'rounded-none border border-green-500/40', 
    envelope: { attack: 0.01, decay: 0.05, sustain: 0.5, release: 0.1 }, 
    gridBase: 'bg-zinc-800/50', 
    playhead: 'bg-green-500', 
    sliderTrack: 'bg-zinc-700' 
  }
};

// ==========================================
// ğŸµ GAME COMPONENT: Groove Maker
// ==========================================

function GrooveMaker({ onExit }) {
  const [totalBars, setTotalBars] = useState(1);
  const [currentBarPage, setCurrentBarPage] = useState(0); 
  const [grid, setGrid] = useState(Array(NOTES.length).fill().map(() => Array(STEPS_PER_BAR * 1).fill(false)));
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [bpm, setBpm] = useState(INITIAL_BPM);
  const [volume, setVolume] = useState(0.3);
  const [currentTheme, setCurrentTheme] = useState(THEMES.winter);
  const [isDrumMasterActive, setIsDrumMasterActive] = useState(false);
  const [drumState, setDrumState] = useState({ kick: true, snare: true, hihat: true, cymbal: false });
  const audioCtxRef = useRef(null);
  const timerRef = useRef(null);
  const noiseBufferRef = useRef(null);

  const initAudio = () => {
    if (!audioCtxRef.current) { audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)(); }
    if (audioCtxRef.current.state === 'suspended') { audioCtxRef.current.resume(); }
    if (!noiseBufferRef.current) {
      const bufferSize = audioCtxRef.current.sampleRate;
      const buffer = audioCtxRef.current.createBuffer(1, bufferSize, audioCtxRef.current.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
      noiseBufferRef.current = buffer;
    }
  };

  const changeTotalBars = (newBars) => {
    if (newBars === totalBars) return;
    const newTotalSteps = newBars * STEPS_PER_BAR;
    setGrid(prevGrid => prevGrid.map(row => {
        const newRow = new Array(newTotalSteps).fill(false);
        for (let i = 0; i < newTotalSteps; i++) { newRow[i] = row[i % row.length]; }
        return newRow;
    }));
    setTotalBars(newBars);
    if (currentBarPage >= newBars) setCurrentBarPage(0);
  };

  const playDrum = useCallback((type) => {
    if (!audioCtxRef.current) return;
    const ctx = audioCtxRef.current;
    const t = ctx.currentTime;
    if (type === 'kick') { const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.001, t + 0.5); gain.gain.setValueAtTime(volume * 2.0, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5); osc.connect(gain); gain.connect(ctx.destination); osc.start(t); osc.stop(t + 0.5); } 
    else if (type === 'snare') { const noise = ctx.createBufferSource(); noise.buffer = noiseBufferRef.current; const noiseFilter = ctx.createBiquadFilter(); noiseFilter.type = 'highpass'; noiseFilter.frequency.value = 1000; const noiseGain = ctx.createGain(); noiseGain.gain.setValueAtTime(volume * 1.2, t); noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.2); noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(ctx.destination); noise.start(t); const osc = ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(100, t); const oscGain = ctx.createGain(); oscGain.gain.setValueAtTime(volume * 0.5, t); oscGain.gain.exponentialRampToValueAtTime(0.001, t + 0.1); osc.connect(oscGain); oscGain.connect(ctx.destination); osc.start(t); osc.stop(t + 0.2); }
    else if (type === 'hihat') { const src = ctx.createBufferSource(); src.buffer = noiseBufferRef.current; const filter = ctx.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = 7000; const gain = ctx.createGain(); gain.gain.setValueAtTime(volume * 0.6, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05); src.connect(filter); filter.connect(gain); gain.connect(ctx.destination); src.start(t); }
    else if (type === 'cymbal') { const src = ctx.createBufferSource(); src.buffer = noiseBufferRef.current; const filter = ctx.createBiquadFilter(); filter.type = 'highpass'; filter.frequency.value = 4000; const gain = ctx.createGain(); gain.gain.setValueAtTime(volume * 1.5, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 1.5); src.connect(filter); filter.connect(gain); gain.connect(ctx.destination); src.start(t); }
  }, [volume]);

  const playSound = useCallback((freq) => {
    if (!audioCtxRef.current) return;
    const ctx = audioCtxRef.current;
    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();
    const { waveform, envelope } = currentTheme;
    osc.type = waveform; osc.frequency.setValueAtTime(freq, ctx.currentTime);
    const now = ctx.currentTime; const { attack, decay, sustain, release } = envelope;
    gainNode.gain.setValueAtTime(0, now); gainNode.gain.linearRampToValueAtTime(volume, now + attack); gainNode.gain.linearRampToValueAtTime(volume * sustain, now + attack + decay); gainNode.gain.exponentialRampToValueAtTime(0.001, now + attack + decay + release);
    osc.connect(gainNode); gainNode.connect(ctx.destination); osc.start(); osc.stop(now + attack + decay + release + 0.1);
  }, [currentTheme, volume]);

  useEffect(() => {
    if (isPlaying) {
      const stepTime = (60 / bpm) / 4 * 1000; const totalSteps = STEPS_PER_BAR * totalBars;
      timerRef.current = setInterval(() => {
        setCurrentStep((prev) => {
          const nextStep = (prev + 1) % totalSteps;
          grid.forEach((row, rowIndex) => { if (row[nextStep]) { playSound(NOTES[rowIndex].freq); } });
          if (isDrumMasterActive) { if (drumState.kick && nextStep % 4 === 0) playDrum('kick'); if (drumState.snare && nextStep % 8 === 4) playDrum('snare'); if (drumState.hihat && nextStep % 2 === 0) playDrum('hihat'); if (drumState.cymbal && nextStep % 16 === 0) playDrum('cymbal'); }
          return nextStep;
        });
      }, stepTime);
    } else { clearInterval(timerRef.current); }
    return () => clearInterval(timerRef.current);
  }, [isPlaying, bpm, grid, playSound, isDrumMasterActive, drumState, playDrum, totalBars]);

  const toggleCell = (rowIndex, stepIndex) => { const actualStepIndex = (currentBarPage * STEPS_PER_BAR) + stepIndex; const newGrid = [...grid]; newGrid[rowIndex][actualStepIndex] = !newGrid[rowIndex][actualStepIndex]; setGrid(newGrid); if (newGrid[rowIndex][actualStepIndex]) { initAudio(); playSound(NOTES[rowIndex].freq); } };
  const clearGrid = () => { setGrid(Array(NOTES.length).fill().map(() => Array(STEPS_PER_BAR * totalBars).fill(false))); setCurrentStep(0); setIsPlaying(false); };
  const randomizeGrid = () => { const newGrid = grid.map(row => row.map(() => Math.random() > 0.85)); setGrid(newGrid); initAudio(); };
  const goNextPage = () => setCurrentBarPage(prev => (prev + 1) % totalBars);
  const goPrevPage = () => setCurrentBarPage(prev => (prev - 1 + totalBars) % totalBars);

  return (
    <div className={`min-h-screen ${currentTheme.bg} transition-colors duration-1000 flex flex-col items-center justify-center p-4 md:p-8 select-none relative`}>
      {/* ë‚˜ê°€ê¸° ë²„íŠ¼ */}
      <button 
        onClick={onExit}
        // Snow í…Œë§ˆì¼ ë•Œ ë²„íŠ¼ ìƒ‰ìƒ ì¡°ì • (ë°°ê²½ì´ ë°ì•„ì§€ë¯€ë¡œ ë²„íŠ¼ì„ ì–´ë‘¡ê²Œ ì²˜ë¦¬)
        className={`fixed top-6 left-6 z-50 flex items-center gap-2 px-4 py-2 rounded-full transition-all backdrop-blur-md ${
          currentTheme.id === 'winter' 
          ? 'bg-slate-900/10 hover:bg-slate-900/20 text-slate-600 border border-slate-200' 
          : 'bg-black/20 hover:bg-black/40 text-white hover:text-white/80 border border-white/10'
        }`}
      >
        <ArrowLeft size={18} />
        <span className="text-sm font-medium">Lobby</span>
      </button>

      {/* ê²Œì„ ì»¨í…Œì´ë„ˆ */}
      <div className={`${currentTheme.panelBg} ${currentTheme.text} w-full max-w-5xl p-6 md:p-10 rounded-[2.5rem] transition-all duration-700 ease-in-out shadow-2xl overflow-visible`}>
        
        {/* í—¤ë” */}
        <div className="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
          <div className="text-center md:text-left">
            <h1 className="text-3xl font-bold tracking-tight mb-1 flex items-center justify-center md:justify-start gap-3">
              <Music size={24} className="opacity-80" />
              Groove Maker 
              <span className="inline-flex items-center justify-center px-2 py-1 rounded-full bg-current/10 border border-current/20 text-[10px] font-sans font-bold leading-none opacity-70">PRO</span>
            </h1>
            <p className="text-sm opacity-60 font-medium">{currentTheme.desc}</p>
          </div>
          {/* í…Œë§ˆ ìŠ¤ìœ„ì²˜ */}
          <div className="flex bg-black/5 p-1.5 rounded-full backdrop-blur-md border border-black/5 overflow-x-auto max-w-full scrollbar-hide">
            {Object.values(THEMES).map((theme) => (
              <button
                key={theme.id}
                onClick={() => setCurrentTheme(theme)}
                className={`flex items-center gap-2 px-4 py-2 rounded-full transition-all duration-300 text-xs font-bold whitespace-nowrap ${
                  currentTheme.id === theme.id ? `${theme.accent} shadow-lg` : 'opacity-50 hover:opacity-100 hover:bg-black/5'
                }`}
              >
                {theme.icon}
                <span className="hidden sm:inline">{theme.name}</span>
              </button>
            ))}
          </div>
        </div>

        {/* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */}
        <div className="flex flex-col lg:flex-row items-center justify-between gap-6 mb-8 px-2 overflow-visible">
          {/* ì¢Œì¸¡: ì¬ìƒ ë° ë„êµ¬ */}
          <div className="flex items-center gap-4 flex-nowrap">
            <button
              onClick={() => { initAudio(); setIsPlaying(!isPlaying); }}
              className={`w-16 h-16 flex-shrink-0 flex items-center justify-center rounded-full transition-all duration-300 shadow-xl hover:scale-105 active:scale-95 ${
                isPlaying ? 'bg-rose-500 text-white shadow-rose-500/40' : `${currentTheme.accent} opacity-100`
              }`}
            >
              {isPlaying ? <Square size={24} fill="currentColor" /> : <Play size={28} fill="currentColor" className="ml-1" />}
            </button>
            
            <div className="flex items-center gap-2">
                <button onClick={clearGrid} className="w-10 h-10 flex items-center justify-center rounded-full bg-black/5 hover:bg-black/10 transition-colors text-current" title="Reset"><RefreshCcw size={18} /></button>
                <button onClick={randomizeGrid} className="w-10 h-10 flex items-center justify-center rounded-full bg-black/5 hover:bg-black/10 transition-colors text-current" title="Randomize"><Activity size={18} /></button>
                
                {/* ë“œëŸ¼ ë²„íŠ¼ & íŒì—… */}
                <div className="relative group">
                  <button
                    onClick={() => { initAudio(); setIsDrumMasterActive(!isDrumMasterActive); }}
                    className={`w-10 h-10 flex items-center justify-center rounded-full transition-all duration-300 ${isDrumMasterActive ? `${currentTheme.accent} shadow-md` : 'bg-black/5 hover:bg-black/10'}`}
                  >
                    <Disc size={18} className={isDrumMasterActive ? 'animate-spin-slow' : ''} />
                  </button>
                   <div className={`absolute bottom-full left-1/2 -translate-x-1/2 mb-3 p-2 bg-[#1e293b] border border-white/10 rounded-2xl shadow-2xl flex gap-1 z-50 backdrop-blur-xl transition-all duration-200 origin-bottom ${isDrumMasterActive ? 'opacity-100 scale-100 translate-y-0' : 'opacity-0 scale-95 translate-y-2 pointer-events-none'}`}>
                    <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 w-3 h-3 bg-[#1e293b] border-b border-r border-white/10 rotate-45"></div>
                    {[{ id: 'kick', label: 'K' }, { id: 'snare', label: 'S' }, { id: 'hihat', label: 'H' }, { id: 'cymbal', label: 'C' }].map((drum) => (
                      <button 
                        key={drum.id} 
                        onClick={(e) => { e.stopPropagation(); setDrumState(prev => ({...prev, [drum.id]: !prev[drum.id]})); }} 
                        // ë“œëŸ¼ í™œì„±í™” ì‹œ í…Œë§ˆ Accent ì»¬ëŸ¬ ì ìš©
                        className={`w-8 h-8 rounded-xl flex items-center justify-center transition-all ${
                          drumState[drum.id] 
                            ? `${currentTheme.accent} font-bold ring-1 ring-white/30 shadow-md` 
                            : 'text-white/30 hover:bg-white/5'
                        }`}
                      >
                         <span className="text-[10px]">{drum.label}</span>
                         {drumState[drum.id] && <div className="absolute bottom-1.5 w-1 h-1 bg-white rounded-full shadow-[0_0_4px_white]" />}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="w-px h-6 bg-current opacity-20 mx-1" />
                <div className="flex gap-1">
                  {[1, 2, 4, 8].map((bar) => (
                    <button key={bar} onClick={() => changeTotalBars(bar)} className={`w-8 h-8 rounded-full text-[10px] font-bold transition-all ${totalBars === bar ? `${currentTheme.accent} shadow-md scale-105 z-10 ring-2 ring-black/10` : 'bg-black/5 opacity-60 hover:opacity-100 hover:bg-black/10'}`}>{bar}x</button>
                  ))}
                </div>
            </div>
          </div>

          {/* ìš°ì¸¡: ì„¤ì •ë¶€ (íšŒìƒ‰ ì»¨í…Œì´ë„ˆ) */}
          <div className="flex items-center gap-6 px-6 py-3 bg-black/5 rounded-2xl flex-shrink-0 backdrop-blur-sm border border-black/5">
             <div className="flex flex-col gap-1 w-24">
                 <div className="flex justify-between text-[10px] font-bold opacity-60"><span>BPM</span><span>{bpm}</span></div>
                 <input type="range" min="60" max="240" value={bpm} onChange={(e) => setBpm(Number(e.target.value))} className={`w-full h-1.5 rounded-full appearance-none cursor-pointer ${currentTheme.sliderTrack} accent-current opacity-80`} />
             </div>
             <div className="flex flex-col gap-1 w-24">
                 <div className="flex justify-between text-[10px] font-bold opacity-60"><span>VOL</span><span>{Math.round(volume * 200)}%</span></div>
                 <input type="range" min="0" max="0.5" step="0.01" value={volume} onChange={(e) => setVolume(Number(e.target.value))} className={`w-full h-1.5 rounded-full appearance-none cursor-pointer ${currentTheme.sliderTrack} accent-current opacity-80`} />
             </div>
          </div>
        </div>

        {/* ê·¸ë¦¬ë“œ ì˜ì—­ */}
        <div className="relative">
          <div className="flex items-center justify-between mb-2 px-2">
             <button onClick={goPrevPage} className="p-2 hover:bg-black/5 rounded-full transition-colors disabled:opacity-20" disabled={totalBars === 1}><ChevronLeft size={20} /></button>
             <div className="flex gap-1">
               {Array(totalBars).fill().map((_, idx) => (
                 <button key={idx} onClick={() => setCurrentBarPage(idx)} className={`h-1.5 rounded-full transition-all duration-300 ${Math.floor(currentStep / STEPS_PER_BAR) === idx && isPlaying ? 'w-8 bg-current opacity-100 shadow-[0_0_10px_currentColor]' : currentBarPage === idx ? 'w-4 bg-current opacity-50' : 'w-2 bg-current opacity-20 hover:opacity-40'}`} />
               ))}
             </div>
             <button onClick={goNextPage} className="p-2 hover:bg-black/5 rounded-full transition-colors disabled:opacity-20" disabled={totalBars === 1}><ChevronRight size={20} /></button>
          </div>

          <div className="relative pt-4 min-h-[300px]">
             {/* í˜„ì¬ í˜ì´ì§€ ì›Œí„°ë§ˆí¬ */}
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-[120px] font-bold opacity-[0.02] pointer-events-none">{currentBarPage + 1}</div>
            
            {/* ì¬ìƒ ë°” */}
            {Math.floor(currentStep / STEPS_PER_BAR) === currentBarPage && (
              <div className={`absolute top-4 bottom-4 w-[2px] z-10 blur-[1px] transition-all duration-[60ms] ease-linear ${currentTheme.playhead}`} style={{ left: `calc(16px + ${(currentStep % STEPS_PER_BAR) / STEPS_PER_BAR * 100} * (100% - 32px) / 100)`, opacity: 0.8, boxShadow: `0 0 15px currentColor` }} />
            )}

            <div className="flex flex-col gap-2 relative z-0">
              {grid.map((row, rowIndex) => {
                const pageRow = row.slice(currentBarPage * STEPS_PER_BAR, (currentBarPage + 1) * STEPS_PER_BAR);
                return (
                  <div key={rowIndex} className="flex items-center gap-3 h-8">
                    <span className="w-8 text-[10px] font-bold text-right opacity-40 pt-1 tracking-wider">{NOTES[rowIndex].name}</span>
                    <div className="flex-1 flex gap-1.5 h-full">
                      {pageRow.map((isActive, colIndex) => {
                        const actualStep = (currentBarPage * STEPS_PER_BAR) + colIndex;
                        const isCurrentStep = currentStep === actualStep;
                        
                        // í•˜ì´ë¼ì´íŠ¸ ë¡œì§: Snow(Winter) í…Œë§ˆì˜ ë¹ˆì¹¸ ì¬ìƒ í‘œì‹œë¥¼ ë§‘ì€ í•˜ëŠ˜ìƒ‰ìœ¼ë¡œ ë³€ê²½
                        const isWinter = currentTheme.id === 'winter';
                        
                        const activeClass = isWinter 
                          ? 'saturate-200 ring-1 ring-black/10 scale-110' 
                          : 'brightness-125 scale-110';                   
                        
                        // Snow í…Œë§ˆì—ì„œ ë¹„í™œì„±í™”ëœ ì…€ì´ ì¬ìƒë  ë•Œ (ë¬¸ì œì˜ íšŒìƒ‰ í‘œì‹œ ìˆ˜ì •)
                        const inactiveClass = isWinter
                          ? 'bg-sky-100/80 ring-1 ring-sky-300/50' // ë§‘ì€ í•˜ëŠ˜ìƒ‰/ì–¼ìŒ íš¨ê³¼
                          : 'brightness-150 ring-1 ring-current/20';      

                        return (
                          <button
                            key={`${rowIndex}-${actualStep}`}
                            onMouseDown={() => toggleCell(rowIndex, colIndex)}
                            onMouseEnter={(e) => { if (e.buttons === 1) toggleCell(rowIndex, colIndex); }}
                            className={`flex-1 h-full transition-all duration-200 ease-out relative 
                              ${currentTheme.shape} 
                              ${isActive 
                                ? `${NOTES[rowIndex].color} opacity-100 scale-100` 
                                : `${currentTheme.gridBase} scale-90 opacity-100 hover:scale-100 hover:bg-black/5`
                              } 
                              ${isCurrentStep && !isActive ? inactiveClass : ''} 
                              ${isCurrentStep && isActive ? activeClass : ''}
                            `}
                            style={{ boxShadow: isActive ? `0 0 12px ${NOTES[rowIndex].glow}` : 'none' }}
                          >
                            {isActive && <div className="absolute top-1 left-1 w-[40%] h-[40%] bg-white rounded-full opacity-40 blur-[1px]" />}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==========================================
// ğŸ  GAME ARCADE LOBBY (Hyun's LAB Theme)
// ==========================================

export default function App() {
  const [activeGame, setActiveGame] = useState(null);

  const games = [
    {
      id: 'groove',
      title: 'Groove Maker',
      desc: 'ê°ì„±ì ì¸ ìŠ¤í… ì‹œí€€ì„œ.',
      icon: <Music className="w-6 h-6 text-white" />,
      color: 'bg-indigo-500',
      component: GrooveMaker
    },
  ];

  if (activeGame) {
    const GameComponent = games.find(g => g.id === activeGame)?.component;
    return <GameComponent onExit={() => setActiveGame(null)} />;
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans selection:bg-sky-200 text-slate-800 overflow-x-hidden relative">
      
      {/* Background Decor (Fog/Mist) */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
         <div className="absolute top-[-20%] left-[-10%] w-[80vw] h-[80vw] bg-sky-100/50 rounded-full blur-[100px] animate-pulse" style={{animationDuration: '10s'}} />
         <div className="absolute bottom-[-20%] right-[-10%] w-[60vw] h-[60vw] bg-indigo-100/40 rounded-full blur-[120px]" />
      </div>

      <div className="relative max-w-7xl mx-auto px-6 py-24">
        
        {/* Header */}
        <header className="mb-24 text-center">
          <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white border border-slate-200 shadow-sm text-slate-500 text-xs font-bold tracking-widest uppercase mb-8">
            <FlaskConical size={14} className="text-sky-400" />
            <span>Hyun's Lab</span>
          </div>
          <h1 className="text-6xl md:text-8xl font-black tracking-tight text-slate-900 mb-6 drop-shadow-sm">
            FUN <span className="text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-indigo-400">THINGS.</span>
          </h1>
          {/* í…ìŠ¤íŠ¸ ìˆ˜ì •: í† ì´ -> ì˜¤ë¸Œì œ */}
          <p className="text-slate-500 text-lg md:text-xl max-w-2xl mx-auto font-medium leading-relaxed">
            ì¬ë¯¸ìˆëŠ” ì•„ì´ë””ì–´ì™€ ì‹¤í—˜ë“¤ì„ ëª¨ì•„ë†“ì€ ê³µê°„ì…ë‹ˆë‹¤.<br/>
            ì›¹ìœ¼ë¡œ êµ¬í˜„ëœ ë‹¤ì–‘í•œ ì¸í„°ë™í‹°ë¸Œ ì˜¤ë¸Œì œë¥¼ ì¦ê²¨ë³´ì„¸ìš”.
          </p>
        </header>

        {/* Bento Grid Layout (White Glass) */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 auto-rows-[340px]">
          
          {/* Main Feature Card - Groove Maker */}
          <div 
            onClick={() => setActiveGame('groove')}
            className="md:col-span-2 relative group cursor-pointer overflow-hidden rounded-[2rem] bg-white/60 backdrop-blur-xl border border-white/60 shadow-lg shadow-slate-200/50 hover:shadow-sky-200/40 hover:-translate-y-1 transition-all duration-500"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-sky-50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
            
            <div className="absolute top-10 left-10 z-10 max-w-md">
              <div className="w-14 h-14 rounded-2xl bg-slate-900 flex items-center justify-center mb-6 shadow-xl shadow-slate-900/10 group-hover:scale-110 transition-transform duration-500">
                <Music className="w-6 h-6 text-white" />
              </div>
              <h3 className="text-4xl font-bold text-slate-800 mb-3 group-hover:text-sky-600 transition-colors">Groove Maker</h3>
              <p className="text-slate-500 text-lg leading-relaxed">ìì‹ ë§Œì˜ ê²¨ìš¸ ë©œë¡œë””ë¥¼ ì‘ê³¡í•´ë³´ì„¸ìš”.<br/>ì§ê´€ì ì¸ ì¸í„°í˜ì´ìŠ¤ì˜ ì›¹ ì‹œí€€ì„œ.</p>
            </div>

            {/* Visual Decoration */}
            <div className="absolute bottom-10 right-10 flex gap-1.5 opacity-30 group-hover:opacity-100 transition-opacity duration-500">
               {[1,2,3,4,5].map(i => (
                 <div key={i} className="w-4 rounded-full bg-sky-400 animate-pulse" style={{ height: `${Math.random() * 60 + 20}px`, animationDelay: `${i * 0.15}s` }} />
               ))}
            </div>
            
            <div className="absolute bottom-10 left-10">
              <span className="inline-flex items-center gap-2 text-sm font-bold text-slate-400 group-hover:text-slate-900 transition-colors border-b border-transparent group-hover:border-slate-900 pb-0.5">
                Start Creating <ChevronRight size={16} />
              </span>
            </div>
          </div>

          {/* Coming Soon */}
          <div className="relative group overflow-hidden rounded-[2rem] bg-white/30 border border-slate-200 border-dashed flex flex-col items-center justify-center text-center p-8 hover:bg-white/50 transition-all cursor-default">
            <div className="w-16 h-16 rounded-full bg-white flex items-center justify-center mb-4 shadow-sm group-hover:scale-110 transition-transform">
              <Wind className="w-6 h-6 text-slate-400 group-hover:text-sky-400 transition-colors" />
            </div>
            <h3 className="text-lg font-bold text-slate-400 group-hover:text-slate-600">More Experiments<br/>Coming Soon</h3>
          </div>

        </div>

      </div>
    </div>
  );
}
