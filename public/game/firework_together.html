<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´ì–´ ë¶ˆê½ƒë†€ì´ (ì‚¬ìš´ë“œ í¬í•¨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #020202; /* ì•„ì£¼ ì–´ë‘ìš´ ë°¤í•˜ëŠ˜ */
            touch-action: none; /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì‹œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'Noto Sans KR', sans-serif;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none; /* í´ë¦­ì´ ìº”ë²„ìŠ¤ë¡œ í†µê³¼ë˜ë„ë¡ */
            color: white;
            z-index: 10;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .instruction {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ff4444;
            margin-right: 8px;
            box-shadow: 0 0 5px #ff4444;
        }
        .status-dot.connected {
            background-color: #44ff44;
            box-shadow: 0 0 5px #44ff44;
        }
        .sound-icon {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1 class="text-2xl font-bold">ğŸ† í•¨ê»˜í•˜ëŠ” ë¶ˆê½ƒë†€ì´ <span class="sound-icon">ğŸ”Š</span></h1>
        <div class="flex items-center mt-2">
            <span id="status-dot" class="status-dot"></span>
            <span id="status-text">ì„œë²„ ì—°ê²° ì¤‘...</span>
        </div>
        <p class="instruction">í™”ë©´ì„ í„°ì¹˜í•˜ë©´ ë¶ˆê½ƒê³¼ ì†Œë¦¬ê°€ ë‚˜ì˜µë‹ˆë‹¤.</p>
        <p class="instruction text-xs text-gray-400 mt-1">ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ë™ì‹œì— ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <canvas id="canvas"></canvas>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================================================================================
        // [GitHub Actions ë°°í¬ìš© ì„¤ì •]
        // ë¡œì»¬ì—ì„œëŠ” 'REPLACE_ME...' ë¬¸ìì—´ì´ ê·¸ëŒ€ë¡œ ìˆì–´ì„œ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ë°°í¬ ì‹œ GitHub Actionsê°€ ì´ ë¬¸ìì—´ì„ ì‹¤ì œ JSON ì„¤ì •ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
        // ==================================================================================
        
        let firebaseConfig;
        let appId = 'fireworks-game-v1';
        let isRealtimeMode = false;

        // 1. í”„ë¦¬ë·° í™˜ê²½ (ìˆ˜ì • ë¶ˆí•„ìš”)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } 
        // 2. GitHub Pages ë°°í¬ í™˜ê²½
        else {
            // ë”°ì˜´í‘œ ì•ˆì— ìˆëŠ” ë¬¸ìì—´ì´ GitHub Actionsì— ì˜í•´ êµì²´ë  íƒ€ê²Ÿì…ë‹ˆë‹¤.
            const configStr = 'REPLACE_ME_WITH_FIREBASE_CONFIG';

            try {
                // ë°°í¬ëœ í™˜ê²½ì´ë¼ë©´ configStrì´ JSON ë¬¸ìì—´ë¡œ ë°”ë€Œì–´ ìˆì„ ê²ƒì…ë‹ˆë‹¤.
                firebaseConfig = JSON.parse(configStr);
            } catch (e) {
                console.warn("Firebase ì„¤ì •ì´ ì•„ì§ ì£¼ì…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ë¡œì»¬ ì‹¤í–‰ ì¤‘ì´ê±°ë‚˜ ë°°í¬ ì„¤ì • ì˜¤ë¥˜)");
                // ë¡œì»¬ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì‹œë¡œ ì•„ë˜ì— ì„¤ì •ì„ ë„£ì–´ì„œ ì“¸ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                // firebaseConfig = { ... } 
            }
        }

        // --- Firebase ì´ˆê¸°í™” ---
        // configê°€ ì—†ìœ¼ë©´ ì•±ì´ ë©ˆì¶”ë¯€ë¡œ ë°©ì–´ ì½”ë“œ ì¶”ê°€
        let app, auth, db;
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isRealtimeMode = true;
        } else {
            document.getElementById('status-text').innerText = "ë¡œì»¬ ëª¨ë“œ (ì„œë²„ ë¯¸ì—°ê²°)";
            document.getElementById('status-dot').classList.add('connected');
            currentUser = { uid: 'local-user' };
        }
        
        // ìƒíƒœ ë³€ìˆ˜
        let currentUser = null;
        let myColor = `hsl(${Math.random() * 360}, 100%, 50%)`; // ë‚´ ê³ ìœ  ìƒ‰ìƒ

        // --- Audio System (Web Audio API) ---
        let audioCtx = null;
        let noiseBuffer = null;

        function initAudio() {
            if (audioCtx) return;
            
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            // 1ì´ˆì§œë¦¬ í™”ì´íŠ¸ ë…¸ì´ì¦ˆ ë²„í¼ ìƒì„± (í­ë°œìŒìš©)
            const bufferSize = audioCtx.sampleRate; 
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
        }

        function playLaunchSound() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            // "ë” ë†’ì€ í”¼ìœµ~" ì†Œë¦¬ (ì£¼íŒŒìˆ˜ ëŒ€ì—­ì„ í›¨ì”¬ ë†’ì„)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(1500, t); // ì‹œì‘ì„ 600 -> 1500ìœ¼ë¡œ ë†’ì„
            osc.frequency.exponentialRampToValueAtTime(4000, t + 0.4); // ëì„ 2500 -> 4000ìœ¼ë¡œ ì•„ì£¼ ë†’ê²Œ

            gain.gain.setValueAtTime(0.05, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.4);

            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start(t);
            osc.stop(t + 0.4);
        }

        function playExplosionSound() {
            if (!audioCtx || !noiseBuffer) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;
            const duration = 1.2;

            // Noise
            const source = audioCtx.createBufferSource();
            source.buffer = noiseBuffer;
            source.playbackRate.value = 0.6; // ì¬ìƒ ì†ë„ë¥¼ ë‚®ì¶°ì„œ ë…¸ì´ì¦ˆ í†¤ì„ ë‚®ê²Œ ë§Œë“¦

            const noiseGain = audioCtx.createGain();
            const noiseFilter = audioCtx.createBiquadFilter();
            
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.setValueAtTime(600, t); // ì‹œì‘ ì£¼íŒŒìˆ˜ ë‚®ì¶¤
            noiseFilter.frequency.exponentialRampToValueAtTime(50, t + duration); // ì•„ì£¼ ë‚®ì€ ê³³ê¹Œì§€ ë–¨ì–´ì§

            source.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioCtx.destination);

            noiseGain.gain.setValueAtTime(0.8, t); // ë³¼ë¥¨ í‚¤ì›€
            noiseGain.gain.exponentialRampToValueAtTime(0.01, t + duration);

            source.start(t);
            source.stop(t + duration);

            // 2. ì„œë¸Œ ë² ì´ìŠ¤ (ì¿µ! - ë¬´ê²Œê° ë‹´ë‹¹)
            const subOsc = audioCtx.createOscillator();
            const subGain = audioCtx.createGain();
            
            subOsc.type = 'triangle'; // ì‚¬ì¸íŒŒë³´ë‹¤ ì¡°ê¸ˆ ë” ê±°ì¹œ ëŠë‚Œ
            subOsc.frequency.setValueAtTime(100, t); // 100Hz í‚¥ ë“œëŸ¼ ëŠë‚Œ
            subOsc.frequency.exponentialRampToValueAtTime(30, t + 0.3); // ë¹ ë¥´ê²Œ ë–¨ì–´ì§

            subGain.gain.setValueAtTime(0.8, t);
            subGain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);

            subOsc.connect(subGain);
            subGain.connect(audioCtx.destination);

            subOsc.start(t);
            subOsc.stop(t + 0.5);
        }

        // --- ìº”ë²„ìŠ¤ ë° ë¶ˆê½ƒë†€ì´ ë¡œì§ ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let fireworks = [];
        let particles = [];
        let cw = window.innerWidth;
        let ch = window.innerHeight;

        // í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
        function resizeCanvas() {
            cw = window.innerWidth;
            ch = window.innerHeight;
            canvas.width = cw;
            canvas.height = ch;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        function calculateDistance(p1x, p1y, p2x, p2y) {
            return Math.sqrt(Math.pow(p1x - p2x, 2) + Math.pow(p1y - p2y, 2));
        }

        // Firework í´ë˜ìŠ¤ (ì˜¬ë¼ê°€ëŠ” ë¡œì¼“)
        class Firework {
            constructor(sx, sy, tx, ty, color) {
                this.x = sx;
                this.y = sy;
                this.sx = sx;
                this.sy = sy;
                this.tx = tx;
                this.ty = ty;
                this.distanceToTarget = calculateDistance(sx, sy, tx, ty);
                this.distanceTraveled = 0;
                this.coordinates = [];
                this.coordinateCount = 3;
                while (this.coordinateCount--) {
                    this.coordinates.push([this.x, this.y]);
                }
                this.angle = Math.atan2(ty - sy, tx - sx);
                this.speed = 2;
                this.acceleration = 1.05;
                this.brightness = random(50, 70);
                this.targetRadius = 1;
                this.color = color;
                
                // ìƒì„± ì‹œ ë°œì‚¬ìŒ ì¬ìƒ
                playLaunchSound();
            }

            update(index) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);

                if (this.targetRadius < 8) {
                    this.targetRadius += 0.3;
                } else {
                    this.targetRadius = 1;
                }

                this.speed *= this.acceleration;
                const vx = Math.cos(this.angle) * this.speed;
                const vy = Math.sin(this.angle) * this.speed;
                this.distanceTraveled = calculateDistance(this.sx, this.sy, this.x + vx, this.y + vy);

                if (this.distanceTraveled >= this.distanceToTarget) {
                    createParticles(this.tx, this.ty, this.color);
                    playExplosionSound();
                    fireworks.splice(index, 1);
                } else {
                    this.x += vx;
                    this.y += vy;
                }
            }

            draw() {
                ctx.beginPath();
                ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                ctx.lineTo(this.x, this.y);
                ctx.strokeStyle = this.color; // ìœ ì € ìƒ‰ìƒ ì‚¬ìš©
                ctx.stroke();
            }
        }

        // Particle í´ë˜ìŠ¤ (í­ë°œ íŒŒí¸)
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.coordinates = [];
                this.coordinateCount = 5;
                while (this.coordinateCount--) {
                    this.coordinates.push([this.x, this.y]);
                }
                this.angle = random(0, Math.PI * 2);
                this.speed = random(1, 10);
                this.friction = 0.95;
                this.gravity = 1;
                this.hue = random(0, 360); // ê¸°ë³¸ ëœë¤ ìƒ‰ìƒì´ì§€ë§Œ ì•„ë˜ì—ì„œ override ê°€ëŠ¥
                this.brightness = random(50, 80);
                this.alpha = 1;
                this.decay = random(0.015, 0.03);
                
                // HSL íŒŒì‹±í•˜ì—¬ ê¸°ë³¸ ìƒ‰ìƒ ì¡ê¸° (ê°„ë‹¨íˆ ì²˜ë¦¬)
                this.baseColor = color; 
            }

            update(index) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                this.speed *= this.friction;
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed + this.gravity;
                this.alpha -= this.decay;

                if (this.alpha <= this.decay) {
                    particles.splice(index, 1);
                }
            }

            draw() {
                ctx.beginPath();
                ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], this.coordinates[this.coordinates.length - 1][1]);
                ctx.lineTo(this.x, this.y);
                ctx.strokeStyle = this.baseColor.replace(')', `, ${this.alpha})`).replace('rgb', 'rgba').replace('hsl', 'hsla');
                ctx.stroke();
            }
        }

        function createParticles(x, y, color) {
            let particleCount = 30;
            while (particleCount--) {
                particles.push(new Particle(x, y, color));
            }
        }

        function loop() {
            requestAnimationFrame(loop);
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, cw, ch);
            ctx.globalCompositeOperation = 'lighter';

            let i = fireworks.length;
            while (i--) {
                fireworks[i].draw();
                fireworks[i].update(i);
            }

            let j = particles.length;
            while (j--) {
                particles[j].draw();
                particles[j].update(j);
            }
        }

        // --- Auth & Data Sync ---
        async function initAuth() {
            if (!auth) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('status-text').innerText = "ì¸ì¦ ì˜¤ë¥˜";
            }
        }

        initAuth();

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('status-dot').classList.add('connected');
                    document.getElementById('status-text').innerText = "ì˜¨ë¼ì¸ (ì°¸ì—¬ ì¤‘)";
                    setupFirestoreListener(user);
                } else {
                    document.getElementById('status-dot').classList.remove('connected');
                    document.getElementById('status-text').innerText = "ì—°ê²° ëŠê¹€";
                }
            });
        }

        function setupFirestoreListener(user) {
            if (!db) return;
            const fireworksRef = collection(db, 'artifacts', appId, 'public', 'data', 'fireworks');
            const startTime = Date.now();

            onSnapshot(fireworksRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        
                        // ë°ì´í„°ê°€ ìƒì„±ëœì§€ 2ì´ˆ ì´ë‚´ì¸ ê²½ìš°ë§Œ ì‹¤í–‰ (ê³¼ê±° ë°ì´í„° ë¬´ì‹œ)
                        if (data.timestamp > startTime - 2000) { 
                            launchFirework(data.ratioX, data.ratioY, data.color);
                        }
                    }
                });
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        }

        // ë¶ˆê½ƒ ë°œì‚¬ í•¨ìˆ˜ (ë¹„ì£¼ì–¼)
        function launchFirework(ratioX, ratioY, color) {
            // ë¹„ìœ¨ ì¢Œí‘œ(0~1)ë¥¼ í˜„ì¬ í™”ë©´ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜
            const targetX = ratioX * cw;
            const targetY = ratioY * ch;
            const startX = cw / 2; // í™”ë©´ ì¤‘ì•™ í•˜ë‹¨ì—ì„œ ì‹œì‘
            const startY = ch;

            fireworks.push(new Firework(startX, startY, targetX, targetY, color));
        }

        // --- ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ (ë°ì´í„° ì „ì†¡) ---
        
        async function handleInput(e) {
            // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” (ì²« ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì‹œ í•„ìˆ˜)
            initAudio();
            if (audioCtx && audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            if (!currentUser) {
                currentUser = { uid: 'local-user' };
            }

            e.preventDefault();
            
            // ì¢Œí‘œ ê³„ì‚° (í„°ì¹˜ ë˜ëŠ” ë§ˆìš°ìŠ¤)
            let clientX, clientY;
            if(e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const ratioX = clientX / cw;
            const ratioY = clientY / ch;
            
            // í•œ ë²ˆì— ë°œì‚¬í•  í­ì£½ ê°œìˆ˜ ëœë¤ ì„¤ì • (3~6ê°œ)
            const fireworkCount = Math.floor(random(3, 7));

            // ì‹¤ì‹œê°„ ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜ DBê°€ ì—†ëŠ” ê²½ìš° ë¡œì»¬ë¡œ ë°”ë¡œ ì¬ìƒ
            if (!isRealtimeMode || !db) {
                for (let i = 0; i < fireworkCount; i++) {
                    const offsetX = random(-0.08, 0.08);
                    const offsetY = random(-0.08, 0.08);
                    const targetRatioX = Math.max(0.05, Math.min(0.95, ratioX + offsetX)); 
                    const targetRatioY = Math.max(0.05, Math.min(0.8, ratioY + offsetY));

                    setTimeout(() => {
                        launchFirework(targetRatioX, targetRatioY, myColor);
                    }, i * 80);
                }
                return;
            }

            const fireworksRef = collection(db, 'artifacts', appId, 'public', 'data', 'fireworks');

            for (let i = 0; i < fireworkCount; i++) {
                // ëª©í‘œ ì§€ì  ì£¼ë³€ìœ¼ë¡œ ì•½ê°„ì˜ ëœë¤ ì˜¤í”„ì…‹ ì¶”ê°€ (í¼ì§€ê²Œ)
                const offsetX = random(-0.08, 0.08);
                const offsetY = random(-0.08, 0.08);
                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ ë²”ìœ„ ì œí•œ
                const targetRatioX = Math.max(0.05, Math.min(0.95, ratioX + offsetX)); 
                const targetRatioY = Math.max(0.05, Math.min(0.8, ratioY + offsetY));

                // ì•½ê°„ì˜ ì‹œì°¨ë¥¼ ë‘ê³  ì „ì†¡í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ë°œ íš¨ê³¼ ì—°ì¶œ
                setTimeout(async () => {
                    try {
                        await addDoc(fireworksRef, {
                            ratioX: targetRatioX,
                            ratioY: targetRatioY,
                            color: myColor,
                            timestamp: Date.now(),
                            userId: currentUser.uid
                        });
                    } catch (err) {
                        console.error("Error adding firework:", err);
                    }
                }, i * 80); // 80ms ê°„ê²©ìœ¼ë¡œ ë°œì‚¬
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput, { passive: false });

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        window.onload = loop;

    </script>
</body>
</html>
